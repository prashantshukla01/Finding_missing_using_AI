{% extends "base.html" %}

{% block title %}Historical & Map View - Missing Person Detection System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 0.5rem;
    }

    .history-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .history-item:hover {
        background-color: #f8f9fa;
    }

    .history-item.active {
        background-color: #e9ecef;
        border-left: 4px solid #0d6efd;
    }

    .history-list {
        height: 600px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-history"></i> Historical & Map View</h2>
        <p class="text-muted">View past detections and camera locations on the map.</p>
    </div>
</div>

<div class="row g-3">
    <!-- Filters and History List -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-filter"></i> Filters & History</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <form id="filterForm" class="mb-3">
                    <div class="mb-2">
                        <label for="personName" class="form-label">Person Name</label>
                        <input type="text" class="form-control" id="personName" placeholder="Search by name...">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    <button type="button" id="resetFilters" class="btn btn-outline-secondary w-100 mt-2">Reset</button>
                </form>

                <hr>

                <div class="flex-grow-1 history-list" id="historyList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map View -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-map-marked-alt"></i> Camera Locations</h5>
            </div>
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    let map;
    let markers = {};
    let detections = [];
    let streamLocations = {};

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        loadData();
    });

    document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        loadHistory();
    });

    document.getElementById('resetFilters').addEventListener('click', () => {
        document.getElementById('personName').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        loadHistory();
    });

    let detectionLayer;

    function initMap() {
        // Default center (New Delhi)
        map = L.map('map').setView([28.6139, 77.2090], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        detectionLayer = L.layerGroup().addTo(map);
    }

    // Custom Red Icon for Detections
    const redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    async function loadData() {
        // Load streams to get locations map
        try {
            const streamsResponse = await fetch('/cctv/streams');
            const streams = await streamsResponse.json();
            streamLocations = {};

            for (const [name, info] of Object.entries(streams)) {
                if (info.lat && info.lng) {
                    streamLocations[name] = {
                        lat: parseFloat(info.lat),
                        lng: parseFloat(info.lng),
                        location: info.location
                    };

                    // Add blue marker for the stream
                    L.marker([parseFloat(info.lat), parseFloat(info.lng)])
                        .bindPopup(`
                            <div class="text-center">
                                <strong>${name}</strong><br>
                                <small>${info.location}</small><br>
                                <span class="badge bg-primary">Camera Location</span>
                            </div>
                        `)
                        .addTo(map);
                }
            }
        } catch (error) {
            console.error('Error loading streams:', error);
        }

        // Load history
        loadHistory();
    }

    async function loadHistory() {
        const personName = document.getElementById('personName').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const params = new URLSearchParams();
        if (personName) params.append('person_name', personName);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate + 'T23:59:59');

        try {
            const response = await fetch(`/api/detections/history?${params.toString()}`);
            detections = await response.json();

            renderHistoryList(detections);
            renderMapMarkers(detections); // Add markers to map
        } catch (error) {
            console.error('Error loading history:', error);
            document.getElementById('historyList').innerHTML = '<p class="text-danger text-center p-3">Error loading history</p>';
        }
    }

    function renderMapMarkers(data) {
        detectionLayer.clearLayers();
        markers = {}; // Reset markers map

        const bounds = [];

        data.forEach((detection, index) => {
            // Get location from detection OR from stream config
            let lat, lng;

            // If detection has specific location data (future proofing)
            if (detection.lat && detection.lng) {
                lat = detection.lat;
                lng = detection.lng;
            }
            // Fallback to stream location
            else if (streamLocations[detection.stream_name]) {
                lat = streamLocations[detection.stream_name].lat;
                lng = streamLocations[detection.stream_name].lng;
            }

            if (lat && lng) {
                const date = new Date(detection.timestamp);
                const timeStr = date.toLocaleString();
                const similarity = (detection.similarity * 100).toFixed(0);

                const marker = L.marker([lat, lng], { icon: redIcon })
                    .bindPopup(`
                        <div class="text-center">
                            <strong>${detection.person_name}</strong><br>
                            <span class="badge bg-danger">Found Here</span><br>
                            <small>${timeStr}</small><br>
                            <small>Confidence: ${similarity}%</small>
                        </div>
                    `)
                    .addTo(detectionLayer);

                markers[index] = marker; // Store by index for easy linking
                bounds.push([lat, lng]);
            }
        });

        if (bounds.length > 0) {
            map.fitBounds(bounds);
        } else if (Object.keys(streamLocations).length > 0) {
            // Fallback to fitting all stream locations if no specific detection markers
            const streamBounds = Object.values(streamLocations).map(l => [l.lat, l.lng]);
            map.fitBounds(streamBounds);
        }
    }

    function renderHistoryList(data) {
        const container = document.getElementById('historyList');

        if (data.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-search-minus fa-2x mb-2"></i>
                    <p>No detections found</p>
                </div>
            `;
            return;
        }

        let html = '';
        data.forEach((detection, index) => {
            const date = new Date(detection.timestamp);
            const timeStr = date.toLocaleString();
            const similarity = (detection.similarity * 100).toFixed(0);

            html += `
                <div class="p-3 border-bottom history-item" onclick="focusOnDetection(${index})">
                    <div class="d-flex justify-content-between">
                        <strong>${detection.person_name}</strong>
                        <small class="text-muted">${timeStr}</small>
                    </div>
                    <div class="small text-muted">
                        <i class="fas fa-video"></i> ${detection.stream_name}
                        <span class="ms-2 badge bg-success">${similarity}% Match</span>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    window.focusOnDetection = function (index) {
        // Highlight in list
        document.querySelectorAll('.history-item').forEach((el, i) => {
            if (i === index) el.classList.add('active');
            else el.classList.remove('active');
        });

        // Focus on map marker
        if (markers[index]) {
            markers[index].openPopup();
            map.setView(markers[index].getLatLng(), 16);
        } else {
            // Try to find stream location if marker doesn't exist (e.g. no geo data for this detection)
            const detection = detections[index];
            if (streamLocations[detection.stream_name]) {
                const loc = streamLocations[detection.stream_name];
                map.setView([loc.lat, loc.lng], 16);
            }
        }
    };
</script>
{% endblock %}